<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../asq-base/asq-base.html">
<link rel="import" href="../../iron-list/iron-list.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../ace-element/ace-element.html">
<link rel="import" href="../../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../../iron-icons/av-icons.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="../../iron-pages/iron-pages.html">
<link rel="import" href="../../paper-tabs/paper-tabs.html">
<link rel="import" href="../../paper-tab/paper-tab.html">

<!--
`asq-java-q` is a Java question type.

Example:

    <asq-java-q tabsize="2">
      <asq-stem><h4>Implement a for loop in Java</h4></asq-stem>
    </asq-java-q>

@element asq-java-q
@demo demo/index.html
@group ASQ Elements
@blurb ASQ Java question.
@homepage http://github.com/ASQ-USI-Elements/asq-java-q
-->
<dom-module id="asq-java-q-viewer">
  <style>
  :host{
    @apply(--layout-vertical);
    @apply(--layout-flex);
    min-width:100px;
    min-height: 300px;
    --paper-toolbar-background: #CFD8DC;
    --paper-toolbar-color: #000;
  }

  #statusMsg{
     padding:0 0.4em;
     @apply(--layout-flex);
  }

  #errorMsg{
    @apply(--asq-java-q-error-message);
    color: red;
    font-family: monospace;
  }

  #le-content{
   @apply(--layout-horizontal);
   @apply(--layout-flex);
   @apply(--asq-java-q-content);
  }

  #main-container{
    @apply(--layout-flex);
    @apply(--layout-vertical);
  }

  #aceContainer{
    @apply(--layout-flex-2);
    position:relative;
    @apply(--asq-java-q-aceContainer);
  }

  #output{
    @apply(--asq-java-q-output);
    @apply(--layout-flex);
    padding: 20px;
    overflow-y: scroll;
    font-size: 0.5em;
  }

  #outputMsg{
    padding-top: 20px;
    font-family: monospace;
  }

  .question-title {
    font-size: 1.5em;
    padding: 20px;
  }

  paper-tabs, paper-toolbar {
    background-color: var(--paper-grey-300);
    color: black;
  }

  paper-tabs {
    --paper-tabs-selection-bar-color : var(--paper-blue-300);
    height: 40px;
  }
  paper-tab {
    --paper-tab-ink: var(--paper-grey-500);
  }

  </style>

  <template>
    <div class="question-title">
      <content select="asq-stem"></content>
    </div>

    <div id="le-content">
      <div id="main-container">

        <paper-toolbar>
          <paper-icon-button id="executeBtn" icon="av:play-arrow" on-tap="_onExecuteBtnTap" title="Run"></paper-icon-button>
          <span id="statusMsg">{{_statusMessage}}</span>
        </paper-toolbar>

        <paper-tabs selected="{{_selectedTab}}">
          <template is="dom-repeat" items="{{fileData.files}}" as="file">
            <paper-tab>{{file.name}}</paper-tab>
          </template>
        </paper-tabs>

        <div id="aceContainer" flex="">
          <iron-pages selected="{{_selectedTab}}">
            <template is="dom-repeat" items="{{fileData.files}}" as="file">
              <ace-element id="{{_computeFileName(file.name)}}" theme="{{theme}}" mode="java" readonly="{{disabled}}" wrap="{{wrap}}" font-size="{{fontSize}}" tab-size="{{tabSize}}">{{file.data}}</ace-element>
            </template>
          </iron-pages>
        </div>
        <div id="output">
          <div id="errorMsg">{{_errorMessage}}</div>
          <div id="outputMsg">{{_outputMessage}}</div>
        </div>
      </div>
    </div>

  </template>
  <script>
    Polymer({
      is: 'asq-java-q-viewer',

      behaviors: [
        ASQ.asqQuestionElementBehavior
      ],

      properties: {
        /**
         * Set to true to style the element as disabled.
         * Binded to `readonly` of ace-editor.
         */
        disabled: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true,
        },
        /**
         * The fontSize property of the ace-element.
         */
        fontSize: {
          type: String,
          value: "14px",
          notify: true,
          reflectToAttribute: true
        },
        /**
         * The mode property of the ace-element.
         */
        mode: {
          type: String,
          value: 'java',
          reflectToAttribute: true,
          notify: true
        },
        /**
         * The tabSize property of the ace-element.
         */
        tabSize: {
          type: Number,
          value: 2,
          notify: true,
          reflectToAttribute: true,
        },
        /**
         * The theme property of the ace-element.
         */
        theme: {
          type: String,
          value: 'monokai',
          notify: true,
          reflectToAttribute: true,
        },
        /**
         * The value property of the ace-element.
         */
        value: {
          type: String,
          value: '',
          notify: true,
          reflectToAttribute: true,
        },
        /**
         * The wrap property of the ace-element.
         */
        wrap: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true,
        },

        _selectedTab:{
          type: Number,
          notify: true,
          value: 0,
          reflectToAttribute: true
        },

        /**
         * Event bus to communicate with ASQ
         */
        eventBus: {
          type: Object,
          notify: true
        },

        _statusMessage: {
          type: String,
          value: 'Press the button to run.',
          notify: true,
          reflectToAttribute: true,
        },
        _errorMessage: {
          type: String,
          value: 'Error goes here.',
          notify: true,
          reflectToAttribute: true,
        },
        _outputMessage: {
          type: String,
          value: 'Output goes here.',
          notify: true,
          reflectToAttribute: true,
        },

        folderName: {
          type: String,
          value: '',
          notify: true,
          reflectToAttribute: true,
        },

        /**
         * Contains the files data
         * Structure example:
         * {
         *    main: 'Main.java',
         *    files: [
         *      {
         *        name: "class1.java",
         *        data: "void hello(){}"
         *      },
         *      {
         *        name: "Main.java",
         *        data: "void main(String[] args){}"
         *      }
         *    ]
         * }
         */
        fileData: {
          type: Object,
          notify: true,
          value: function() {
            return {
              // main: 'Main.java',
              // files: [
              //   {
              //     name: "class1.java",
              //     data: "void hello(){}"
              //   },
              //   {
              //     name: "Main.java",
              //     data: "void main(String[] args){}"
              //   }
              // ]
            };
          },
          observer: '_fileDataChanged',
        },
      },

      attached: function(){
        //delay to make sure ace-editors are initialized
        setTimeout(function(){
          console.log("Sent files");
          this.eventBus.emit('asq-plugin', {
            type: 'asq-java-q',
            data: {
              type: 'getFiles',
              questionUid: this.uid,
            }
          });
          // this.$.editor.addEventListener('editor-input', this._editorValueChanged.bind(this))
          // this.$.editor.editor.resize();
        }.bind(this), 1)
      },

      _valueChanged: function(newVal){
        if(this.value && this.$.editor.editorValue != this.value){
          this.$.editor.editorValue = this.value;
          this.$.editor.editor.clearSelection(1);
        }
      },

      _editorValueChanged: function(evt){
        console.log("changing");
        this.value = evt.target.editorValue;
      },

      _computeFileName: function(fileName) {
        return fileName.split('.')[0];
      },


      _refreshData: function() {
        this.fileData.files.forEach(function(file) {
          let name = file.name.split('.')[0];
          file.data = this.$$('#'+name).editorValue;
        }, this);
      },

      /**
       * When pressing the run button, send the data to the backend
       * for compilation.
       */
      _onExecuteBtnTap: function (evt) {
        this._refreshData();
        this._statusMessage = "Running";

        this.eventBus.emit('asq-plugin', {
          type: 'asq-java-q',
          data: {
            questionUid: this.uid,
            type: 'run',
            timestamp: new Date(),
            submission: this.fileData
          }
        });
      },

      /**
       * The `submit` method returns an object that respresents the submission of this question. The object has the following structure:
           {
              questionUid: this.uid,
              timestamp: new Date(),
              submission: this.value
           }
       * Only enabled when the `role` of the element is <b>viewer</b>.
       *
       * @method submit
       */
      submit: function (evt) {
        this._statusMessage = "Running";
        this._refreshData();

        let submission = this.value;
        return {
          questionUid: this.uid,
          timestamp: new Date(),
          submission: this.fileData,
        };
      },

      _onQuestionType: function (evt) {
        console.log("Event received", evt);
        if (!evt || !evt.questionType)
          return;
        if (evt.questionType == 'asq-java-q') {
          if (evt.type == 'restoreViewer') {
            this._onRestoreViewer(evt);
          } else if (evt.type == 'output') {
            this._onReceiveResult(evt); // Show compilation and run results
          } else if (evt.type == 'getFiles') {
            this._onReceiveFiles(evt); // Show compilation and run results
          }
        }
      },


      _onReceiveFiles: function(evt) {
        console.log("Received files:", evt);
        console.log("ID", this.uid);
        if (evt.questionUid != this.uid)
          return;
        this.set('fileData', evt.data);
      },


      _onRestoreViewer: function (evt) {
        evt.questions.forEach(function (q) {
          if (q.uid != this.uid)
            return;
         this.value = q.submission;
        }.bind(this));
      },

      /**
        Response structure:
        {
          clientId: String,
          passed: Boolean,
          output: String,
          errorMessage: String,
          timeOut: Boolean
        }
       */
      _onReceiveResult: function(evt) {
        // Only accept when it's the correct slide
        if (evt.data.questionUid != this.uid)
          return;
        this._statusMessage = evt.data.passed ? 'Build successful' : 'Build failed';
        this._outputMessage = evt.data.output;
        this._errorMessage = evt.data.errorMessage;
      },

      _eventBusChanged: function (eventBus, old) {
        if(!eventBus) return;
        eventBus.on('asq:question_type', this._onQuestionType.bind(this));
      },

      _fileDataChanged: function(fileData, old) {
        console.log("New fileData:", fileData);
        // this.fileData = fileData;
      },
    });
  </script>
</dom-module>
