<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../asq-base/asq-base.html">
<link rel="import" href="../../iron-list/iron-list.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../ace-element/ace-element.html">
<link rel="import" href="../../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">

<!--
`asq-java-q` is a Java question type.

Example:

    <asq-java-q tabsize="2">
      <asq-stem><h4>Implement a for loop in Java</h4></asq-stem>
    </asq-java-q>

@element asq-java-q
@demo demo/index.html
@group ASQ Elements
@blurb ASQ Java question.
@homepage http://github.com/ASQ-USI-Elements/asq-java-q
-->
<dom-module id="asq-java-q-viewer">
  <style>
    :host[disabled]{
      opacity:0.65;
    }
    :host{
      @apply(--layout-vertical);
      @apply(--layout-flex);
      position: relative;
      min-width:100px;
      min-height: 300px;
    }
    #aceContainer{
      @apply(--layout-flex);
      position:relative;
    }
  </style>
  <template>
    <div id="leContent"><content select="asq-stem"></content></div>
    <div id="aceContainer" flex="">
      <ace-element id="editor" theme="{{theme}}" mode="{{mode}}" readonly="{{disabled}}" wrap="{{wrap}}" font-size="{{fontSize}}" tab-size="{{tabSize}}">[[value]]</ace-element>
    </div>
  </template>
  <script>
    Polymer({
      is: 'asq-java-q-viewer',

      properties: {
        /**
         * Set to true to style the element as disabled.
         * Binded to `readonly` of ace-editor.
         */
        disabled: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true,
        },
        /**
         * The fontSize property of the ace-element.
         */
        fontSize: {
          type: String,
          value: "12px",
          notify: true,
          reflectToAttribute: true
        },
        /**
         * The mode property of the ace-element.
         */
        mode: {
          type: String,
          value: 'java',
          reflectToAttribute: true,
          notify: true
        },
        /**
         * The tabSize property of the ace-element.
         */
        tabSize: {
          type: Number,
          value: 2,
          notify: true,
          reflectToAttribute: true,
        },
        /**
         * The theme property of the ace-element.
         */
        theme: {
          type: String,
          value: 'monokai',
          notify: true,
          reflectToAttribute: true,
        },
        /**
         * The value property of the ace-element.
         */
        value: {
          type: String,
          value: '',
          notify: true,
          reflectToAttribute: true,
          observer: '_valueChanged'
        },
        /**
         * The wrap property of the ace-element.
         */
        wrap: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true,
        },
        /**
         * Event bus to communicate with ASQ
         */
        eventBus: {
          type: Object,
          observer: "_eventBusChanged",
          notify: true
        }
      },
      /**
       * The `submit` method returns an object that respresents the submission of this question. The object has the following structure:
           {
              questionUid: this.uid,
              timestamp: new Date(),
              submission: []
           }
       * Only enabled when the `role` of the element is <b>viewer</b>.
       *
       * @method submit
       */
      // submit: function () {
      //   var submission = this.$.editor.editor.session.getValue();
      //   return {
      //     submission: submission
      //   };
      // },
      attached: function(){
        //delay to make sure ace-editors are initialized
        setTimeout(function(){
          this.$.editor.addEventListener('editor-input', this._editorValueChanged.bind(this))
          this.$.editor.editor.resize();
        }.bind(this), 1)
      },
      _valueChanged: function(newVal){
        if(this.value && this.$.editor.editorValue != this.value){
          this.$.editor.editorValue = this.value;
          this.$.editor.editor.clearSelection(1);
        }
      },
      _editorValueChanged: function(evt){
        this.value = evt.target.editorValue;
      },
      /**
       * The `submit` method returns an object that respresents the submission of this question. The object has the following structure:
           {
              questionUid: this.uid,
              timestamp: new Date(),
              submission: this.value
           }
       * Only enabled when the `role` of the element is <b>viewer</b>.
       *
       * @method submit
       */
      submit: function () {
        if (!this.value) {
          this.value = '';
        }
        submission = this.value;
        return {
          questionUid: this.uid,
          timestamp: new Date(),
          submission: submission
        };
      },
      // ready: function () {
      //   if (!this.value) {
      //     var code = Polymer.dom(this).querySelector('code');
      //     if (code) {
      //       //this.value = code.textContent;
      //       //console.log(code.textContent)
      //     }
      //   }
      // }
      _onQuestionType: function (evt) {
        if (!evt || !evt.questionType)
          return;
        if (evt.questionType == 'asq-code-q') {
          if (evt.type == 'restoreViewer') {
            this._onRestoreViewer(evt);
          }
        }
      },
      _onRestoreViewer: function (evt) {
        evt.questions.forEach(function (q) {
          if (q.uid != this.uid)
            return;
         this.value = q.submission;
        }.bind(this));
      },
      _eventBusChanged: function (eventBus, old) {
        if(!eventBus) return;
        eventBus.on('asq:question_type', this._onQuestionType.bind(this));
      }
    });
  </script>
</dom-module>
